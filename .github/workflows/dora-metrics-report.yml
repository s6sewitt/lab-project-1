name: DORA Metrics Report

on:
  schedule:
    # Runs at 7:00 AM UTC every Monday
    - cron: '0 7 * * 1'
  
  # This allows you to run it manually from the Actions tab
  workflow_dispatch:

jobs:
  calculate-metrics:
    runs-on: ubuntu-latest

    # Grant permissions for the GitHub CLI to read your repo data
    permissions:
      contents: read
      pull-requests: read
      issues: read

    steps:
      - name: Calculate DORA Metrics for the Last 30 Days
        env:
          # This is the secure, built-in token. No PAT needed.
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Calculating DORA metrics for the period 30 days ago to today."
          
          # Set the start date for our query (30 days ago)
          START_DATE=$(date -v-30d +%Y-%m-%d)

          #=================================================
          # 1. DEPLOYMENT FREQUENCY (DF)
          #=================================================
          # We count the number of merge commits to 'main'
          echo "--- 1. Deployment Frequency ---"
          DEPLOYMENT_COUNT=$(gh search commits --query "repo:${{ github.repository }} is:merge merge_date:>$START_DATE base:main" --json mergedAt | jq 'length')
          echo "Total deployments in the last 30 days: $DEPLOYMENT_COUNT"


          #=================================================
          # 2. LEAD TIME FOR CHANGES (LTFC)
          #=================================================
          # We measure the average time from PR creation to PR merge.
          # This is a strong, simple proxy for Lead Time.
          echo "--- 2. Lead Time for Changes (LTFC) ---"
          AVG_LEAD_TIME_HOURS=$(gh pr list --state merged --base main --search "merged:>$START_DATE" --json createdAt,mergedAt | \
                                jq '[.[] | ( ((.mergedAt | fromdateiso8601) - (.createdAt | fromdateiso8601)) / 3600 )] | add / length | .')
          
          if [ -z "$AVG_LEAD_TIME_HOURS" ] || [ "$AVG_LEAD_TIME_HOURS" = "null" ]; then
            echo "No PRs merged in this period."
          else
            echo "Average Lead Time for Changes: $AVG_LEAD_TIME_HOURS hours"
          fi


          #=================================================
          # 3. CHANGE FAILURE RATE (CFR)
          #=================================================
          # This requires a process change: You must start creating a
          # GitHub Issue with the label "incident" or "bug" for each failure.
          echo "--- 3. Change Failure Rate (CFR) ---"
          # We will look for issues labeled "incident"
          FAILURE_COUNT=$(gh issue list --label "incident" --search "created:>$START_DATE" --json number | jq 'length')
          echo "Failures (issues labeled 'incident') in last 30 days: $FAILURE_COUNT"

          if [ "$DEPLOYMENT_COUNT" -gt 0 ]; then
            CFR=$(echo "scale=2; ($FAILURE_COUNT / $DEPLOYMENT_COUNT) * 100" | bc)
            echo "Change Failure Rate: $CFR%"
          else
            echo "Change Failure Rate: 0% (No deployments)"
          fi


          #=================================================
          # 4. MEAN TIME TO RESTORE (MTTR)
          #=================================================
          # This also requires the "incident" issue process.
          # It measures the time from issue creation to issue close.
          echo "--- 4. Mean Time to Restore (MTTR) ---"
          AVG_MTTR_HOURS=$(gh issue list --state closed --label "incident" --search "closed:>$START_DATE" --json createdAt,closedAt | \
                             jq '[.[] | ( ((.closedAt | fromdateiso8601) - (.createdAt | fromdateiso8601)) / 3600 )] | add / length | .')

          if [ -z "$AVG_MTTR_HOURS" ] || [ "$AVG_MTTR_HOURS" = "null" ]; then
            echo "No incidents were resolved in this period."
          else
            echo "Average Mean Time to Restore: $AVG_MTTR_HOURS hours"
          fi
