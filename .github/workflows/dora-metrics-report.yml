name: DORA Metrics Report

on:
  schedule:
    # Runs at 7:00 AM UTC every Monday
    - cron: '0 7 * * 1'
  
  # This allows you to run it manually from the Actions tab
  workflow_dispatch:

jobs:
  calculate-metrics:
    runs-on: ubuntu-latest

    # Grant permissions for the GitHub CLI to read your repo data
    permissions:
      contents: read
      pull-requests: read
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate DORA Metrics for the Last 30 Days
        env:
          # Use the built-in token.
          # The GH_TOKEN is automatically read by gh.
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Calculating DORA metrics for the period 30 days ago to today."
          START_DATE=$(date -d "30 days ago" +%Y-%m-%d)

          #=================================================
          # 1. DEPLOYMENT FREQUENCY (DF)
          #=================================================
          echo "--- 1. Deployment Frequency ---"
          # CORRECTED: Removed the 'repo:' part.
          # The gh command knows the repo from the checkout step.
          DF_JSON=$(gh search commits "is:merge merge_date:>$START_DATE base:main" --json sha)
          DEPLOYMENT_COUNT=$(echo "$DF_JSON" | jq 'length')
          echo "Total deployments in the last 30 days: $DEPLOYMENT_COUNT"

          #=================================================
          # 2. LEAD TIME FOR CHANGES (LTFC)
          #=================================================
          echo "--- 2. Lead Time for Changes (LTFC) ---"
          # This command was already correct as it didn't use 'repo:'
          PR_JSON=$(gh pr list --state merged --base main --search "merged:>$START_DATE" --json createdAt,mergedAt)
          PR_COUNT=$(echo "$PR_JSON" | jq 'length')
          
          if [ "$PR_COUNT" -gt 0 ]; then
            TOTAL_LEAD_TIME_SECONDS=$(echo "$PR_JSON" | jq '[.[] | ((.mergedAt | fromdateiso8601) - (.createdAt | fromdateiso8601))] | add')
            AVG_LEAD_TIME_HOURS=$(echo "scale=2; $TOTAL_LEAD_TIME_SECONDS / $PR_COUNT / 3600" | bc)
            echo "Average Lead Time for Changes: $AVG_LEAD_TIME_HOURS hours (from $PR_COUNT merged PRs)"
          else
            echo "No PRs merged in this period."
          fi

          #=================================================
          # 3. CHANGE FAILURE RATE (CFR)
          #=================================================
          echo "--- 3. Change Failure Rate (CFR) ---"
          # Gracefully handle if 'gh issue list' fails (e.g., Issues disabled)
          FAILURE_JSON=$(gh issue list --label "incident" --search "created:>$START_DATE" --json number 2>/dev/null)
          
          if [ -z "$FAILURE_JSON" ]; then
            echo "Could not query issues (Issues may be disabled). Defaulting to 0 failures."
            FAILURE_COUNT=0
          else
            FAILURE_COUNT=$(echo "$FAILURE_JSON" | jq 'length')
          fi
          echo "Failures (issues labeled 'incident') in last 30 days: $FAILURE_COUNT"

          if [ "$DEPLOYMENT_COUNT" -gt 0 ]; then
            CFR=$(echo "scale=2; ($FAILURE_COUNT / $DEPLOYMENT_COUNT) * 100" | bc)
            echo "Change Failure Rate: $CFR%"
          else
            echo "Change Failure Rate: 0% (No deployments)"
          fi

          #=================================================
          # 4. MEAN TIME TO RESTORE (MTTR)
          #=================================================
          echo "--- 4. Mean Time to Restore (MTTR) ---"
          # Gracefully handle if 'gh issue list' fails
          INCIDENT_JSON=$(gh issue list --state closed --label "incident" --search "closed:>$START_DATE" --json createdAt,closedAt 2>/dev/null)
          
          if [ -z "$INCIDENT_JSON" ]; then
            echo "Could not query issues (Issues may be disabled). Defaulting to 0 incidents."
            INCIDENT_COUNT=0
          else
            INCIDENT_COUNT=$(echo "$INCIDENT_JSON" | jq 'length')
          fi

          if [ "$INCIDENT_COUNT" -gt 0 ]; then
            TOTAL_MTTR_SECONDS=$(echo "$INCIDENT_JSON" | jq '[.[] | ((.closedAt | fromdateiso8601) - (.createdAt | fromdateiso8601))] | add')
            AVG_MTTR_HOURS=$(echo "scale=2; $TOTAL_MTTR_SECONDS / $INCIDENT_COUNT / 3600" | bc)
            echo "Average Mean Time to Restore: $AVG_MTTR_HOURS hours (from $INCIDENT_COUNT resolved incidents)"
          else
            echo "No incidents were resolved in this period."
          fi
